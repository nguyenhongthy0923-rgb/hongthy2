<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo Dõi Cảm Xúc 5 Ngày</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .mood-score-10 { background-color: #10b981; }
        .mood-score-8 { background-color: #3b82f6; }
        .mood-score-6 { background-color: #f97316; }
        .mood-score-4 { background-color: #f43f5e; }
        .mood-score-2 { background-color: #94a3b8; }
        .quiz-option input[type="radio"] { display: none; }
        .quiz-option label {
            display: block; padding: 8px 12px; border: 2px solid #e5e7eb;
            border-radius: 8px; cursor: pointer; background: #f8fafc; transition: .2s;
        }
        .quiz-option input[type="radio"]:checked + label {
            background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; font-weight: 600;
        }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-chart-line text-indigo-500 mr-3"></i>
                Theo Dõi Cảm Xúc 5 Ngày (Trắc Nghiệm)
            </h1>
            <p class="text-gray-500 italic">Trả lời 6 câu hỏi để đánh giá toàn diện cảm xúc ngày hôm nay.</p>
            <p id="user-info" class="text-xs text-gray-400 mt-2"></p>
        </header>

        <div id="loading" class="text-center p-10">
            <i class="fas fa-spinner fa-spin text-indigo-500 text-3xl"></i>
        </div>

        <div id="tracker-container" class="bg-white p-6 md:p-8 shadow-xl rounded-xl hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Tiến Độ Theo Dõi</h2>
            <div id="mood-days" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4"></div>

            <div class="mt-10">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">Tổng quan 5 ngày</h2>
                <div id="mood-chart" class="w-full h-40 bg-gray-50 rounded-lg p-3 flex items-end justify-around gap-2 shadow-inner">
                    <p id="chart-placeholder" class="text-gray-400 text-center w-full">Chưa có dữ liệu.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="mood-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">Nhập Cảm Xúc</h3>

            <form id="mood-form" class="space-y-4">
                <div id="quiz-container"></div>

                <div>
                    <label class="block text-gray-700 font-medium mb-2">Ghi chú thêm:</label>
                    <textarea id="optional-note" class="w-full p-3 border rounded-lg"></textarea>
                </div>

                <p class="text-xl font-bold text-gray-700">Điểm: <span id="calculated-score-display" class="text-indigo-600">--</span></p>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Hủy</button>
                    <button type="submit" id="save-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // FIREBASE CONFIG (KHÔNG DÙNG BIẾN BÊN CANVAS NỮA)
    const firebaseConfig = {
        apiKey: "AIzaSyCj-_LubNDwDLweSpQrY534u0V8B3ZXJGU",
        authDomain: "theodoicamxuc.firebaseapp.com",
        projectId: "theodoicamxuc",
        storageBucket: "theodoicamxuc.firebasestorage.app",
        messagingSenderId: "608066933880",
        appId: "1:608066933880:web:30382ba83db0c3a12ec98d",
        measurementId: "G-4KSTPSLP76"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId = null;
    let currentDayToEdit = null;
    const totalDays = 5;
    const moodData = {};

    const QUIZ_QUESTIONS = [
        { id: 'q1', label: 'Năng lượng hôm nay?', options: [10, 7, 4, 1] },
        { id: 'q2', label: 'Cảm xúc chung?', options: [10, 7, 4, 1] },
        { id: 'q3', label: 'Tập trung?', options: [10, 7, 4, 1] },
        { id: 'q4', label: 'Xã hội?', options: [10, 7, 4, 1] },
        { id: 'q5', label: 'Giấc ngủ?', options: [10, 7, 4, 1] },
        { id: 'q6', label: 'Căng thẳng?', options: [10, 7, 4, 1] }
    ];

    function getCollectionPath(uid) {
        return `users/${uid}/mood`;
    }

    function calculateFinalScore(sum) {
        return Math.round(sum / 6);
    }

    // AUTH
    onAuthStateChanged(auth, async u => {
        if (!u) await signInAnonymously(auth);
        else {
            userId = u.uid;
            document.getElementById("user-info").innerText = `User ID: ${userId}`;
            loadData();
        }
    });

    // Load dữ liệu
    function loadData() {
        const ref = collection(db, getCollectionPath(userId));
        onSnapshot(ref, (snap) => {
            snap.forEach(doc => moodData[doc.data().day] = doc.data());
            renderUI();
        });
    }

    // UI
    function renderUI() {
        const container = document.getElementById("tracker-container");
        const days = document.getElementById("mood-days");
        const loading = document.getElementById("loading");
        const chart = document.getElementById("mood-chart");

        loading.classList.add("hidden");
        container.classList.remove("hidden");
        days.innerHTML = "";
        chart.innerHTML = "";

        let hasData = false;

        for (let day = 1; day <= totalDays; day++) {
            const data = moodData[day];
            const score = data?.score ?? "--";

            days.insertAdjacentHTML("beforeend", `
                <button onclick="openModal(${day})"
                    class="p-4 rounded-lg bg-indigo-500 text-white shadow-md">
                    <p class="text-xs font-bold">Ngày ${day}</p>
                    <p class="text-3xl font-bold">${score}</p>
                </button>
            `);

            if (data) {
                hasData = true;
                const h = (data.score / 10) * 100;
                chart.insertAdjacentHTML("beforeend", `
                    <div class="flex flex-col items-center">
                        <div class="w-8 bg-indigo-400" style="height:${h}%"></div>
                        <span class="text-xs">N${day}</span>
                    </div>
                `);
            }
        }

        if (!hasData)
            chart.innerHTML = `<p class="text-gray-400 w-full text-center">Chưa có dữ liệu.</p>`;
    }

    // Modal
    window.openModal = function(day) {
        currentDayToEdit = day;
        document.getElementById('modal-title').innerText = `Nhập Cảm Xúc Ngày ${day}`;
        document.getElementById('mood-modal').classList.remove('hidden');
        renderQuizForm();
    }

    window.closeModal = function() {
        document.getElementById('mood-modal').classList.add('hidden');
    }

    function renderQuizForm() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = "";

        QUIZ_QUESTIONS.forEach(q => {
            let html = `
                <div>
                    <p class="font-semibold mb-1">${q.label}</p>
                    <div class="flex gap-2">
            `;
            q.options.forEach(val => {
                html += `
                    <div class="quiz-option flex-1">
                        <input type="radio" id="${q.id}-${val}" name="${q.id}" value="${val}">
                        <label for="${q.id}-${val}">${val}</label>
                    </div>
                `;
            });

            html += "</div></div>";
            container.insertAdjacentHTML("beforeend", html);
        });
    }

    // SAVE
    document.getElementById("mood-form").addEventListener("submit", async e => {
        e.preventDefault();

        let sum = 0;
        const answers = {};

        for (const q of QUIZ_QUESTIONS) {
            const input = document.querySelector(`input[name="${q.id}"]:checked`);
            if (!input) return alert("Bạn chưa trả lời đủ.");

            const value = parseInt(input.value);
            answers[q.id] = value;
            sum += value;
        }

        const score = calculateFinalScore(sum);
        const note = document.getElementById("optional-note").value;

        await setDoc(doc(db, getCollectionPath(userId), `day_${currentDayToEdit}`), {
            day: currentDayToEdit,
            score,
            answers,
            note,
            time: new Date().toISOString()
        });

        closeModal();
    });

</script>

</body>
</html>
